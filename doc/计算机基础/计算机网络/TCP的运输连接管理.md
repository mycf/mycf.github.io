**TCP是面向连接的协议，它基于运输连接来传送TCP报文段。

**TCP运输连接的建立和释放，是每一次面向连接的通信中必不可少的过程。

**TCP运输连接有以下三个阶段**
	第一个阶段是**建立TCP连接**，也就是通过三报文握手来建立TCP连接。
	第二个阶段是**数据传送**，也就是基于已建立的TCP连接进行可靠的数据传输。
	第三个阶段是***释放连接***，也就是在数据传输结束后，还要通过四报文挥手来释放TCP连接。
	
TCP的运输连接管理就是使运输连接的建立和释放都能正常的进行。

TCP的连接建立要解决以下三个问题：
1. 使TCP双方能够确知对方的存在：
2. 使TCP双方能够协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等）；
3. 使TCP双方能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配；

# 接下来我们就来看看TCP使用三报文握手建立连接的具体过程
这是两台要基于TCP进行通信的主机，其中一台主机中的某个应用进程主动发起TCP连接建立，称为==TCP客户==。 另一台主机中被动等待TCP连接建立的应用进程称为==TCP服务器==。我们可以将TCP建立连接的过程比喻为握手，握手需要在TCP客户和服务器之间**交换三个TCP报文段**。

最初两端的TCP进程都处于*关闭状态*。一开始TCP服务器进程首先*创建传输控制块*，用来存储TCP连接中的一些重要信息。 例如TCP连接表、指向发送和接收缓存的指针、指向重传队列的指针、当前发送和接收序号等。之后，就准备接受TCP客户进程的连接请求。

此时TCP服务器进程就要进入*监听状态*，**等待TCP客户进程的连接请求**。TCP服务器进程是被动等待来自TCP客户进程的连接请求，而不是主动发起，因此称为***被动打开连接***

TCP客户进程也是首先**创建传输控制块**，然后在打算建立TCP连接时，向TCP服务器进程发送**TCP连接请求报文段**，并进入**同步已发送状态**。
TCP连接请求报文段首部中的同步位`SYN被设置为1`，表明这是一个**TCP连接请求报文段**。序号字段seq被设置了一个初始值 x，作为TCP客户进程所选择的初始序号。
请注意：TCP规定`SYN`被设置为1的报文段，不能携带数据，但要消耗掉一个序号。
由于TCP连接建立是由TCP客户进程主动发起的，因此称为**主动打开连接**。

TCP服务器进程收到TCP连接请求报文段后，如果同意建立连接，则向TCP客户进程发送**TCP连接请求确认报文段**，并进入**同步已接收状态**。
该报文段首部中的**同步位SYN和确认位ACK都设置为1**，表明这是一个TCP连接请求确认报文段。序号字段seq被设置了一个初始值y， 作为TCP服务器进程所选择的初始序号，确认号字段ack的值被设置成了x+1，这是对TCP客户进程所选择的初始序号的确认。 
请注意：这个报文段也不能携带数据，因为它是SYN被设置为1的报文段，但同样要消耗掉一个序号。

TCP客户进程收到TCP连接请求确认报文段后，还要向TCP服务器进程发送一个普通的TCP确认报文段并进入*连接已建立状态*。该报文段首部中的确认位ACK被设置为1，表明这是一个普通的TCP确认报文段。序号字段seq被设置为x+1，这是因为TCP客户进程发送的第一个TCP报文段的序号为x，并且不携带数据，因此第二个报文段的序号为x+1。

请注意：TCP规定普通的TCP确认报文段可以携带数据，但如果不携带数据，则不消耗序号。在这种情况下，所发送的下一个数据报文段的序号仍是x+1。

确认号字段ack被设置为y+1，这是对TCP服务器进程所选择的初始序号的确认。
**TCP服务器进程收到该确认报文段后也进入连接已建立状态。**
现在TCP双方都进入了连接已建立状态，他们可以基于已建立好的TCP连接进行可靠的数据传输了。

# 为什么TCP客户进程最后还要发送一个普通的TCP确认报文段呢？
换句话说，能否使用两报文握手建立连接呢，答案是并不多余，不能简化为两报文握手

我们来举例说明。考虑这样一种情况，TCP客户进程发出一个TCP连接请求报文段，但该报文段在某些网络节点长时间滞留了，这必然会造成该报文段的超时重传。假设重传的报文段被TCP服务器进程正常接收，TCP服务器进程给TCP客户进程发送一个TCP连接请求确认报文段，并进入连接已建立状态。
请注意：由于我们改为两报文握手，因此TCP服务器进程发送完TCP连接请求确认报文段后，进入的是连接已建立状态<而不像三报文握手那样进入同步已接收状态，并等待TCP客户进程发来针对TCP连接请求确认报文段的普通确认报文段。TCP客户进程收到TCP连接请求确认报文段后，进入TCP连接已建立状态， 但不会给TCP服务器进程发送针对该报文段的普通确认报文段，现在TCP双方都处于连接已建立状态。 他们可以相互传输数据之后可以通过四报文挥手来释放连接，TCP双方都进入了关闭状态。
一段时间后，之前滞留在网络中的那个失效的TCP连接请求，报文段到达了TCP服务器进程。TCP服务器进程会误认为这是TCP客户进程又发起了一个新的TCP连接请求。于是给TCP客户进程发送TCP连接请求确认报文段并进入连接已建立状态，该报文段到达TCP客户进程，由于TCP客户进程并没有发起新的TCP连接请求并且处于关闭状态，因此不会理会该报文段。但TCP服务器进程已进入了连接已建立状态，他认为新的TCP连接已建立好了，并一直等待TCP客户进程发来数据，这将白白浪费TCP服务器进程所在主机的很多资源。
综上所述，采用三报文握手，而不是两报文握手来建立TCP连接，是为了防止以失效的连接请求报文段突然又传送到了TCP服务器进程 因而导致错误。
