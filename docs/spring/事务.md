```mermaid
flowchart TD
    A[开始] --> B[参数处理]
    B --> C{definition是否为null?}
    C -->|是| D[使用默认TransactionDefinition]
    C -->|否| E[使用传入definition]
    D & E --> F[调用doGetTransaction获取事务对象]
    F --> G{是否存在现有事务?}
    
    G -->|是| H[调用handleExistingTransaction处理]
    H --> I{传播行为判断}
    I -->|PROPAGATION_REQUIRED| J[加入当前事务]
    I -->|PROPAGATION_REQUIRES_NEW| K[挂起当前事务并创建新事务]
    I -->|PROPAGATION_NESTED| L[创建保存点]
    I -->|其他| M[按规则处理或抛异常]
    
    G -->|否| N[检查超时设置]
    N --> O{超时是否有效?}
    O -->|无效| P[抛出InvalidTimeoutException]
    O -->|有效| Q{传播行为判断}
    
    Q -->|PROPAGATION_MANDATORY| R[抛出IllegalTransactionStateException]
    Q -->|PROPAGATION_REQUIRED/<br>PROPAGATION_REQUIRES_NEW/<br>PROPAGATION_NESTED| S[挂起资源并startTransaction]
    S --> T[调用doBegin开始新事务]
    T --> U[prepareTransactionStatus]
    
    Q -->|其他传播行为| V[创建空事务状态]
    V --> W[prepareTransactionStatus]
    
    U & W & J & K & L --> X[返回TransactionStatus]
    P & R --> Y[结束并抛异常]
    
    style A stroke:#333,fill:#f9f
    style X stroke:#090,fill:#dfd
    style Y stroke:#900,fill:#fdd
```


```plantuml
@startuml
start

group 参数初始化
  :参数处理;
  if (definition == null?) then (是) #lightblue
    :使用默认TransactionDefinition;
  else (否) #lightblue
    :使用传入的definition;
  endif
end group

:调用doGetTransaction()获取事务对象;

if (存在现有事务?) then (是) #palegreen
  group 处理现有事务
    :调用handleExistingTransaction();
    switch (传播行为)
      case (PROPAGATION_REQUIRED) #lightgreen
        :加入当前事务;
      case (PROPAGATION_REQUIRES_NEW) #lightgreen
        :挂起当前事务\n创建新事务;
      case (PROPAGATION_NESTED) #lightgreen
        :创建保存点;
      case (其他) #pink
        :按规则处理或抛异常;
    endswitch
  end group
else (否) #palegreen
  group 创建新事务
    :检查超时设置;
    if (超时无效?) then (是) #pink
      :抛出InvalidTimeoutException;
      stop
    else (否)
      switch (传播行为)
        case (PROPAGATION_MANDATORY) #pink
          :抛出IllegalTransactionStateException;
          stop
        case (PROPAGATION_REQUIRED/REQUIRES_NEW/NESTED) #lightblue
          :挂起资源;
          :调用startTransaction();
          :调用doBegin()开始新事务;
        case (其他) #lightgray
          :创建空事务状态;
      endswitch
    endif
    :prepareTransactionStatus();
  end group
endif

:返回TransactionStatus;
stop

@enduml
```
